<html>
  <script src="./../compiler.js"></script>
  <script src="./../runner.js"></script>
  <template id="runner-template">
  </template>

  <script>
  //---------------------------------------
  function r3reset(){
    r3domx=-1;
    r3showx=-1
  }

  function r3step() {
    if (ip==0) { return; }
    r3op(memcode[ip++]);
  }

  function r3run() {
    if (boot==-1) { return; }
    r3showx!=-1
    RTOS=255;stack[255]=0;
    ip=boot;
    while(ip!=0) { r3op(memcode[ip++]); }
  }

  function r3runa(adr) {
    RTOS=255;stack[255]=0;
    ip=adr;
    while(ip!=0) { r3op(memcode[ip++]); }
  }

  function interceptable (func) {
    const {name} = func;
    window[name] = func;
    window[name].intercept = function(interceptor) {
      window[name] = function (...args) {
        return interceptor.bind(this, func, args)();
      };
    };
  }


  interceptable(function r3Run() {
    r3compile();
    r3reset();
    r3run();
    redraw();
    dumpVM();
    document.getElementById("r3dom").innerHTML=r3echo;
  });

  function r3Compile() {
    let src = localStorage.getItem(r3source);
    var cc=r3compile();
    if (cc>-1) {
    var i,ll=0;lin=0;
    for(i=0;i<cc;i++){ if(src[i]=="\n") {lin++;ll=i+1;} }
    var c=cc-ll;
    editor.focus();
    editor.setCursor({line:lin,ch:c});
      }
    dumpVM();
    }


  var runnerWindow;
  function playintab() {
    let src = localStorage.getItem(r3source);
    r3includes();
    let presource=includes.map(inc=>localStorage.getItem(inc)).join("");
    localStorage.setItem("runable", `${presource+"\n"}${src}`);

    runnerWindow = runnerWindow && !runnerWindow.closed;
    const {location} = runnerWindow || window.open("r3-runner-window");
    const href = "./runner.html";
    const hash = r3source;
    location.replace(`${href}#${hash}`);
  }


  customElements.define(
    'r3-runner-button',
    class r3RunnerButton extends HTMLButtonElement {
      connectedCallback () {
        const type = this.getAttribute("type");
        const handlers = {
          run: () => r3Run(),
          playintab: playintab,
          compile: r3Compile,
          step: () => {r3step();dumpVM();redraw();}
        };
        this.onclick = handlers[type];
      }
    },
    {extends: "button"}
  );

  class r3Runner extends HTMLElement {
    constructor () {
      super();
    }
    connectedCallback () {
      if (!!this.getAttribute("autorun") || this.hasAttribute("autorun")) {
        r3reset();
        r3run();
      }
    }
  }
  customElements.define('r3-runner', r3Runner);


  </script>
</html>
